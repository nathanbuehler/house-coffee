<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Nathan's Coffee Menu</title>
    <style>
      body {
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
          sans-serif;
        margin: 0;
        padding: 0;
        background-color: #f5f5f5;
        color: #333;
      }
      header {
        background-color: #333;
        color: #fff;
        padding: 1rem;
      }
      header h1 {
        margin: 0;
        font-size: 1.4rem;
      }
      header p {
        margin: 0.25rem 0 0;
        font-size: 0.9rem;
        opacity: 0.8;
      }
      main {
        padding: 1rem;
        max-width: 900px;
        margin: 0 auto;
      }
      .menu-selector {
        margin-bottom: 1rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }
      .menu-selector select {
        padding: 0.4rem;
        font-size: 0.9rem;
      }
      .menu-container {
        background: #fff;
        padding: 1rem;
        border-radius: 6px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
        margin-bottom: 1.5rem;
      }
      .menu-header h2 {
        margin: 0 0 0.25rem;
      }
      .menu-header p {
        margin: 0;
        font-size: 0.9rem;
        color: #555;
      }
      .category {
        margin-top: 1.2rem;
      }
      .category h3 {
        margin: 0 0 0.3rem;
        font-size: 1rem;
      }
      .category hr {
        border: none;
        border-top: 1px solid #eee;
        margin: 0.2rem 0 0.6rem;
      }
      .drink-item {
        margin-bottom: 0.6rem;
      }
      .drink-title {
        font-weight: 600;
      }
      .drink-description {
        font-size: 0.9rem;
        color: #555;
      }
      .badge {
        display: inline-block;
        padding: 0.1rem 0.4rem;
        font-size: 0.7rem;
        border-radius: 999px;
        background-color: #f3f4f6;
        color: #4b5563;
        margin-left: 0.4rem;
      }
      .order-form {
        background: #fff;
        padding: 1rem;
        border-radius: 6px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
      }
      .order-form h2 {
        margin-top: 0;
      }
      .form-row {
        margin-bottom: 0.75rem;
      }
      .form-row label {
        display: block;
        font-size: 0.85rem;
        margin-bottom: 0.25rem;
      }
      .form-row input,
      .form-row select,
      .form-row textarea {
        width: 100%;
        padding: 0.4rem;
        font-size: 0.9rem;
        border-radius: 4px;
        border: 1px solid #d1d5db;
      }
      .form-row textarea {
        min-height: 60px;
        resize: vertical;
      }
      .form-row-inline {
        display: flex;
        gap: 0.75rem;
      }
      .form-row-inline > div {
        flex: 1;
      }
      .form-actions {
        margin-top: 0.75rem;
        display: flex;
        gap: 0.5rem;
        align-items: center;
      }
      .btn-primary {
        background-color: #2563eb;
        color: #fff;
        border: none;
        border-radius: 4px;
        padding: 0.4rem 0.8rem;
        font-size: 0.9rem;
        cursor: pointer;
      }
      .btn-primary:disabled {
        opacity: 0.6;
        cursor: default;
      }
      .status-message {
        font-size: 0.85rem;
        color: #4b5563;
      }
      .small-note {
        font-size: 0.8rem;
        color: #6b7280;
      }
      @media (max-width: 700px) {
        .form-row-inline {
          flex-direction: column;
        }
      }
    </style>
  </head>
  <body>
    <header>
      <h1>Nathan's Coffee</h1>
      <p>Pick a drink, add your preferences, submit. Human barista sold separately.</p>
    </header>

    <main>
      <section class="menu-selector">
        <label for="menu-select">Menu:</label>
        <select id="menu-select"></select>
        <span id="menu-select-status" class="small-note"></span>
      </section>

      <section class="menu-container" id="menu-container">
        <div class="small-note">Loading menu…</div>
      </section>

      <section class="order-form">
        <h2>Place an order</h2>
        <p class="small-note">
          This creates an order in the host view. No payment, just chaos.
        </p>
        <form id="order-form">
          <div class="form-row">
            <label for="customer-name-input">Name</label>
            <input
              id="customer-name-input"
              type="text"
              placeholder="Your name"
              required
            />
          </div>

          <div class="form-row">
            <label for="drink-select">Drink</label>
            <select id="drink-select" required>
              <option value="">Select a drink</option>
            </select>
          </div>

          <div class="form-row-inline">
            <div class="form-row">
              <label for="milk-select">Milk</label>
              <select id="milk-select">
                <option value="">None / default</option>
                <option value="Whole">Whole</option>
                <option value="Skim">Skim</option>
                <option value="Oat">Oat</option>
                <option value="Almond">Almond</option>
                <option value="Soy">Soy</option>
              </select>
            </div>
            <div class="form-row">
              <label for="iced-select">Iced</label>
              <select id="iced-select">
                <option value="no">Hot</option>
                <option value="yes">Iced</option>
              </select>
            </div>
          </div>

          <div class="form-row-inline">
            <div class="form-row">
              <label for="syrup-select">Add syrup?</label>
              <select id="syrup-select">
                <option value="no">No syrup</option>
                <option value="yes">Add syrup</option>
              </select>
            </div>
            <div class="form-row">
              <label for="syrup-flavour-select">Syrup flavour</label>
              <select id="syrup-flavour-select" disabled>
                <option value="">Select flavour</option>
              </select>
            </div>
          </div>

          <div class="form-row">
            <label for="notes-input">Notes</label>
            <textarea
              id="notes-input"
              placeholder="Extra hot, decaf, not too sweet, etc."
            ></textarea>
          </div>

          <div class="form-actions">
            <button type="submit" class="btn-primary" id="submit-order-btn">
              Submit order
            </button>
            <span id="order-status" class="status-message"></span>
          </div>
        </form>
      </section>
    </main>

    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script>
      const menuSelect = document.getElementById("menu-select");
      const menuSelectStatus =
        document.getElementById("menu-select-status");
      const menuContainerEl =
        document.getElementById("menu-container");

      const orderForm = document.getElementById("order-form");
      const customerNameInput =
        document.getElementById("customer-name-input");
      const drinkSelect = document.getElementById("drink-select");
      const milkSelect = document.getElementById("milk-select");
      const icedSelect = document.getElementById("iced-select");
      const syrupSelect = document.getElementById("syrup-select");
      const syrupFlavourSelect = document.getElementById(
        "syrup-flavour-select"
      );
      const notesInput = document.getElementById("notes-input");
      const submitOrderBtn =
        document.getElementById("submit-order-btn");
      const orderStatus = document.getElementById("order-status");

      const SUPABASE_URL = localStorage.getItem("coffee-host-connection")
        ? JSON.parse(localStorage.getItem("coffee-host-connection")).url
        : "";
      const SUPABASE_KEY = localStorage.getItem("coffee-host-connection")
        ? JSON.parse(localStorage.getItem("coffee-host-connection")).key
        : "";

      let supabaseClient = null;
      let menusCache = [];
      let currentMenu = null;
      let currentMenuDrinks = [];
      let syrupsCache = [];

      function setStatus(el, message) {
        if (!el) return;
        el.textContent = message || "";
      }

      function initSupabase() {
        if (!SUPABASE_URL || !SUPABASE_KEY) {
          setStatus(
            menuSelectStatus,
            "Supabase connection not configured in host view."
          );
          return;
        }
        supabaseClient = window.supabase.createClient(
          SUPABASE_URL,
          SUPABASE_KEY
        );
      }

      async function fetchMenus() {
        const { data, error } = await supabaseClient
          .from("menus")
          .select("*")
          .order("is_default", { ascending: false })
          .order("updated_at", { ascending: false });

        if (error) {
          console.error("Error fetching menus:", error);
          setStatus(menuSelectStatus, "Error loading menus.");
          return [];
        }
        console.log("Guest menus:", data);
        return data || [];
      }

      async function fetchMenuItems(menuId) {
        const { data, error } = await supabaseClient
          .from("menu_items")
          .select(
            "*, drinks!inner(name, description, categories(name))"
          )
          .eq("menu_id", menuId)
          .order("sort_order", { ascending: true });

        if (error) {
          console.error("Error fetching menu items:", error);
          return [];
        }

        console.log("Menu items fetched:", data);
        return data || [];
      }

      async function fetchSyrups() {
        const { data, error } = await supabaseClient
          .from("syrups")
          .select("*")
          .order("name", { ascending: true });

        if (error) {
          console.error("Error fetching syrups:", error);
          return [];
        }
        console.log("Guest syrups:", data);
        return data || [];
      }

      function populateMenuSelect() {
        menuSelect.innerHTML = "";
        if (!menusCache.length) {
          const opt = document.createElement("option");
          opt.value = "";
          opt.textContent = "No menus available";
          menuSelect.appendChild(opt);
          menuSelect.disabled = true;
          return;
        }

        menuSelect.disabled = false;
        menusCache.forEach((m) => {
          const opt = document.createElement("option");
          opt.value = m.id;
          opt.textContent = m.name;
          menuSelect.appendChild(opt);
        });

        if (currentMenu) {
          menuSelect.value = currentMenu.id;
        } else {
          const defaultMenu =
            menusCache.find((m) => m.is_default) || menusCache[0];
          currentMenu = defaultMenu;
          menuSelect.value = defaultMenu.id;
        }
      }

      function groupDrinksByCategory(menuItems) {
        const grouped = {};
        for (const item of menuItems) {
          const drink = item.drinks;
          const category =
            drink && drink.categories && drink.categories.name
              ? drink.categories.name
              : "Other";
          if (!grouped[category]) grouped[category] = [];
          grouped[category].push(item);
        }
        return grouped;
      }

      function renderMenu() {
        menuContainerEl.innerHTML = "";

        if (!currentMenu) {
          menuContainerEl.innerHTML =
            '<p class="small-note">No menu selected.</p>';
          return;
        }

        const headerDiv = document.createElement("div");
        headerDiv.className = "menu-header";
        headerDiv.innerHTML = `
          <h2>${currentMenu.name || ""}</h2>
          <p>${currentMenu.description || ""}</p>
        `;
        menuContainerEl.appendChild(headerDiv);

        if (!currentMenuDrinks.length) {
          const p = document.createElement("p");
          p.className = "small-note";
          p.textContent = "No drinks configured for this menu.";
          menuContainerEl.appendChild(p);
          return;
        }

        const grouped = groupDrinksByCategory(currentMenuDrinks);
        const categoryNames = Object.keys(grouped).sort();

        categoryNames.forEach((catName) => {
          const catDiv = document.createElement("div");
          catDiv.className = "category";
          catDiv.innerHTML = `
            <h3>${catName}</h3>
            <hr />
          `;
          const listDiv = document.createElement("div");

          grouped[catName].forEach((item) => {
            const drink = item.drinks;
            const dDiv = document.createElement("div");
            dDiv.className = "drink-item";
            dDiv.innerHTML = `
              <div class="drink-title">${drink.name}</div>
              ${
                drink.description
                  ? `<div class="drink-description">${drink.description}</div>`
                  : ""
              }
            `;
            listDiv.appendChild(dDiv);
          });

          catDiv.appendChild(listDiv);
          menuContainerEl.appendChild(catDiv);
        });
      }

      function populateDrinkSelect() {
        drinkSelect.innerHTML =
          '<option value="">Select a drink</option>';
        if (!currentMenuDrinks.length) {
          drinkSelect.disabled = true;
          return;
        }
        drinkSelect.disabled = false;

        currentMenuDrinks.forEach((item) => {
          const drink = item.drinks;
          const opt = document.createElement("option");
          opt.value = item.drinks_id || item.drink_id || drink.id;
          opt.textContent = drink.name;
          drinkSelect.appendChild(opt);
        });
      }

      function populateSyrupFlavours() {
        syrupFlavourSelect.innerHTML =
          '<option value="">Select flavour</option>';
        syrupsCache.forEach((s) => {
          const opt = document.createElement("option");
          opt.value = s.name;
          opt.textContent = s.name;
          syrupFlavourSelect.appendChild(opt);
        });
      }

      function handleSyrupSelectChange() {
        const choice = syrupSelect.value;
        if (choice === "yes") {
          syrupFlavourSelect.disabled = false;
        } else {
          syrupFlavourSelect.disabled = true;
          syrupFlavourSelect.value = "";
        }
      }

      syrupSelect.addEventListener("change", handleSyrupSelectChange);

      async function handleMenuChange() {
        const menuId = menuSelect.value;
        if (!menuId) {
          currentMenu = null;
          currentMenuDrinks = [];
          renderMenu();
          populateDrinkSelect();
          return;
        }

        currentMenu = menusCache.find((m) => m.id === menuId) || null;
        if (!currentMenu) {
          currentMenuDrinks = [];
          renderMenu();
          populateDrinkSelect();
          return;
        }

        setStatus(menuSelectStatus, "Loading drinks…");
        const items = await fetchMenuItems(menuId);
        currentMenuDrinks = items;
        renderMenu();
        populateDrinkSelect();
        setStatus(menuSelectStatus, "");
      }

      menuSelect.addEventListener("change", handleMenuChange);

      async function handleOrderSubmit(e) {
        e.preventDefault();
        if (!supabaseClient) {
          setStatus(
            orderStatus,
            "Supabase connection not configured. Ask the host to set it up."
          );
          return;
        }

        if (!currentMenu) {
          setStatus(orderStatus, "No menu selected.");
          return;
        }

        const customerName = customerNameInput.value.trim();
        const drinkId = drinkSelect.value;
        const milk = milkSelect.value || null;
        const iced = icedSelect.value === "yes";
        const addSyrup = syrupSelect.value === "yes";
        const syrupFlavour =
          addSyrup && syrupFlavourSelect.value
            ? syrupFlavourSelect.value
            : null;
        const notes = notesInput.value.trim();

        if (!customerName) {
          setStatus(orderStatus, "Please enter your name.");
          return;
        }
        if (!drinkId) {
          setStatus(orderStatus, "Please select a drink.");
          return;
        }
        if (addSyrup && !syrupFlavour) {
          setStatus(orderStatus, "Please pick a syrup flavour.");
          return;
        }

        const item = currentMenuDrinks.find((i) => {
          const id = i.drinks_id || i.drink_id || (i.drinks && i.drinks.id);
          return id == drinkId;
        });

        if (!item || !item.drinks) {
          setStatus(orderStatus, "Selected drink not found.");
          return;
        }

        const drinkName = item.drinks.name;

        const payload = {
          menu_id: currentMenu.id,
          customer_name: customerName,
          drink: drinkName,
          milk,
          iced,
          syrup: addSyrup,
          syrup_flavour: syrupFlavour,
          notes,
          is_completed: false
        };

        submitOrderBtn.disabled = true;
        setStatus(orderStatus, "Submitting order…");

        const { error } = await supabaseClient
          .from("orders")
          .insert(payload);

        submitOrderBtn.disabled = false;

        if (error) {
          console.error("Error submitting order:", error);
          setStatus(orderStatus, "Error submitting order. Try again.");
          return;
        }

        setStatus(orderStatus, "Order submitted!");
        orderForm.reset();
        handleSyrupSelectChange();
      }

      orderForm.addEventListener("submit", handleOrderSubmit);

      async function bootstrap() {
        initSupabase();
        if (!supabaseClient) return;

        setStatus(menuSelectStatus, "Loading…");

        menusCache = await fetchMenus();
        syrupsCache = await fetchSyrups();

        populateMenuSelect();
        populateSyrupFlavours();
        handleSyrupSelectChange();

        if (currentMenu) {
          const items = await fetchMenuItems(currentMenu.id);
          currentMenuDrinks = items;
        }

        renderMenu();
        populateDrinkSelect();
        setStatus(menuSelectStatus, "");
      }

      bootstrap();
    </script>
  </body>
</html>
