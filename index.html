<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Thistle & Cherry Blossom</title>
    <style>
      body {
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
          sans-serif;
        margin: 0;
        padding: 0;
        background-color: #f5f5f5;
        color: #333;
      }

      header {
        background-color: #333;
        color: #fff;
        padding: 1rem;
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        flex-wrap: wrap;
        gap: 0.75rem;
      }

      .header-main {
        display: flex;
        flex-direction: column;
        gap: 0.25rem;
      }

      header h1 {
        margin: 0;
        font-size: 1.4rem;
      }

      header p {
        margin: 0.25rem 0 0;
        font-size: 0.9rem;
        opacity: 0.8;
      }

      .header-nav {
        display: flex;
        align-items: center;
      }

      .header-nav a {
        font-size: 0.85rem;
        text-decoration: none;
        color: #e5e7eb;
        border: 1px solid #6b7280;
        border-radius: 999px;
        padding: 0.25rem 0.7rem;
        background-color: #111827;
      }

      .header-nav a:hover {
        background-color: #1f2937;
      }

      main {
        padding: 1rem;
        max-width: 900px;
        margin: 0 auto;
      }

      h1,
      h2,
      h3 {
        margin-bottom: 0.5rem;
      }

      .section {
        background: #fff;
        margin-bottom: 1.5rem;
        padding: 1rem;
        border-radius: 6px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
      }

      .menu-header {
        display: flex;
        flex-direction: column;
        gap: 0.25rem;
      }

      .menu-header-title-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .menu-last-updated {
        font-size: 0.8rem;
        color: #666;
      }

      .menu-description {
        font-size: 0.9rem;
        color: #555;
      }

      /* Category container & collapsible styling */
      .menu-category {
        margin-top: 0.75rem;
        border: 1px solid #e5e7eb;
        border-radius: 6px;
        overflow: hidden;
        background: #fff;
      }

      .menu-category-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0.45rem 0.6rem;
        cursor: pointer;
        background: #f3f4f6;
        border-bottom: 1px solid #e5e7eb;
      }

      .menu-category-header:hover {
        background: #e5e7eb;
      }

      .menu-category-title {
        margin: 0;
        font-size: 0.95rem;
        font-weight: 600;
      }

      .menu-category-chevron {
        font-size: 0.85rem;
        opacity: 0.7;
      }

      .menu-drinks-container {
        padding: 0.4rem 0.6rem 0.6rem;
      }

      .menu-category.collapsed .menu-drinks-container {
        display: none;
      }

      .drink-card {
        border-radius: 6px;
        border: 1px solid #e5e7eb;
        padding: 0.6rem;
        margin-bottom: 0.5rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 0.5rem;
      }

      .drink-info {
        flex: 1;
      }

      .drink-name {
        font-weight: 600;
        margin-bottom: 0.1rem;
      }

      .drink-description {
        font-size: 0.85rem;
        color: #555;
      }

      .drink-actions {
        display: flex;
        align-items: center;
      }

      .btn-select {
        padding: 0.3rem 0.6rem;
        font-size: 0.8rem;
        border-radius: 999px;
        border: 1px solid #2563eb;
        background: #eff6ff;
        color: #1d4ed8;
        cursor: pointer;
      }

      .menu-empty-text {
        font-size: 0.9rem;
        color: #777;
        font-style: italic;
      }

      .menu-select-row {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        margin-bottom: 0.75rem;
        flex-wrap: wrap;
      }

      .menu-select-row label {
        font-size: 0.85rem;
      }

      .menu-select-row select {
        padding: 0.3rem 0.5rem;
        font-size: 0.9rem;
      }

      .order-name-note {
        font-size: 0.8rem;
        color: #666;
        margin-top: 0.2rem;
      }

      .form-row {
        margin-bottom: 0.75rem;
      }

      .form-row label {
        display: block;
        font-size: 0.9rem;
        margin-bottom: 0.25rem;
      }

      .form-row input,
      .form-row select,
      .form-row textarea {
        width: 100%;
        box-sizing: border-box;
        padding: 0.4rem;
        font-size: 0.9rem;
        border-radius: 4px;
        border: 1px solid #d1d5db;
      }

      .form-row textarea {
        resize: vertical;
      }

      /* QOL: make inline rows vertical at all sizes */
      .form-row-inline {
        display: block;
      }

      .radio-group {
        display: flex;
        gap: 1rem;
        flex-wrap: wrap;
      }

      .radio-group label {
        display: inline-flex;
        align-items: center;
        gap: 0.25rem;
        font-size: 0.9rem;
      }

      .order-section-header {
        display: flex;
        justify-content: space-between;
        align-items: baseline;
        margin-bottom: 0.5rem;
        gap: 0.5rem;
        flex-wrap: wrap;
      }

      .order-section-header p {
        margin: 0;
        font-size: 0.85rem;
        color: #555;
      }

      .btn-primary {
        background-color: #2563eb;
        color: #fff;
        border-radius: 4px;
        border: none;
        padding: 0.4rem 0.9rem;
        font-size: 0.9rem;
        cursor: pointer;
      }

      .btn-primary:disabled {
        opacity: 0.6;
        cursor: default;
      }

      .status-message {
        font-size: 0.85rem;
        color: #555;
      }

      .status-error {
        color: #b91c1c;
      }

      .status-success {
        color: #065f46;
      }

      @media (max-width: 600px) {
        .drink-card {
          flex-direction: column;
          align-items: flex-start;
        }

        .drink-actions {
          align-self: stretch;
          justify-content: flex-end;
        }
      }
    </style>
  </head>
  <body>
    <header>
      <div class="header-main">
        <h1>Thistle & Cherry Blossom</h1>
        <p>Pick a drink, add your preferences, submit. No tipping prompt, you’re welcome.</p>
      </div>
      <nav class="header-nav">
        <a href="host.html">Host view</a>
      </nav>
    </header>

    <main>
      <section class="section">
        <div class="menu-select-row">
          <label for="menu-select">Menu:</label>
          <select id="menu-select"></select>
          <span id="menu-status" class="status-message"></span>
        </div>

        <div class="menu-header">
          <div class="menu-header-title-row">
            <h2 id="menu-title">Menu</h2>
            <span id="menu-last-updated" class="menu-last-updated"></span>
          </div>
          <p id="menu-description" class="menu-description">
            Browse the drinks below.
          </p>
        </div>

        <div id="menu-container" style="margin-top: 0.75rem;"></div>
      </section>

      <section class="section">
        <div class="order-section-header">
          <h2>Place an order</h2>
          <p>This creates an order on the host view. No payment, just chaos.</p>
        </div>

        <form id="order-form">
          <div class="form-row">
            <label for="customer-name-input">Your name</label>
            <input
              id="customer-name-input"
              type="text"
              placeholder="Name they'll yell out"
              required
            />
            <div class="order-name-note">
              Use something they’ll recognise. “Latte Goblin” is acceptable.
            </div>
          </div>

          <div class="form-row">
            <label for="drink-select">Drink</label>
            <select id="drink-select" required>
              <option value="">Loading drinks…</option>
            </select>
          </div>

          <!-- Now vertical: milk section then iced section -->
          <div class="form-row-inline">
            <div class="form-row">
              <label for="milk-select">Milk</label>
              <select id="milk-select">
                <option value="">None / default</option>
                <option value="Whole">Whole</option>
                <option value="Skim">Skim</option>
                <option value="Oat">Oat</option>
                <option value="Almond">Almond</option>
                <option value="Soy">Soy</option>
              </select>
            </div>
            <div class="form-row">
              <label>Iced?</label>
              <div class="radio-group" id="iced-group">
                <label>
                  <input type="radio" name="iced" value="no" checked />
                  Hot
                </label>
                <label>
                  <input type="radio" name="iced" value="yes" />
                  Iced
                </label>
              </div>
            </div>
          </div>

          <!-- Now vertical: syrup choice then flavour -->
          <div class="form-row-inline">
            <div class="form-row">
              <label>Add syrup?</label>
              <div class="radio-group" id="syrup-group">
                <label>
                  <input type="radio" name="syrup" value="no" checked />
                  No syrup
                </label>
                <label>
                  <input type="radio" name="syrup" value="yes" />
                  Add syrup
                </label>
              </div>
            </div>
            <div class="form-row">
              <label for="syrup-flavour-select">Syrup flavour</label>
              <select id="syrup-flavour-select" disabled>
                <option value="">Select a flavour</option>
              </select>
            </div>
          </div>

          <div class="form-row">
            <label for="notes-input">Notes</label>
            <textarea
              id="notes-input"
              placeholder="Extra hot, less ice, single shot, etc."
            ></textarea>
          </div>

          <div class="form-row" style="display: flex; align-items: center; gap: 0.75rem;">
            <button type="submit" class="btn-primary" id="submit-order-btn">
              Submit order
            </button>
            <span id="status-message" class="status-message"></span>
          </div>
        </form>
      </section>
    </main>

    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script>
      // Hard-coded Supabase credentials – must match host.html
      const SUPABASE_URL = "https://cyfdiuyjzcrommxldpwp.supabase.co";
      const SUPABASE_KEY = "sb_publishable_hzG6hrSF4DBFz9FrGC-Ghw_MSbQCHFo";

      const supabaseClient = window.supabase.createClient(
        SUPABASE_URL,
        SUPABASE_KEY
      );

      const menuSelectEl = document.getElementById("menu-select");
      const menuStatusEl = document.getElementById("menu-status");
      const menuContainerEl = document.getElementById("menu-container");
      const menuTitleEl = document.getElementById("menu-title");
      const menuDescriptionEl = document.getElementById("menu-description");
      const menuLastUpdatedEl = document.getElementById("menu-last-updated");

      const orderForm = document.getElementById("order-form");
      const customerNameInput = document.getElementById("customer-name-input");
      const drinkSelectEl = document.getElementById("drink-select");
      const milkSelect = document.getElementById("milk-select");
      const syrupFlavourSelect = document.getElementById("syrup-flavour-select");
      const notesInput = document.getElementById("notes-input");
      const submitOrderBtn = document.getElementById("submit-order-btn");
      const statusMessageEl = document.getElementById("status-message");

      const syrupChoiceRadios = document.querySelectorAll('input[name="syrup"]');
      const icedChoiceRadios = document.querySelectorAll('input[name="iced"]');

      let currentMenu = null;
      let currentMenuDrinks = [];
      let currentMenuSyrups = [];

      function setStatus(message, isError = false, isSuccess = false) {
        statusMessageEl.textContent = message || "";
        statusMessageEl.classList.remove("status-error", "status-success");
        if (isError) statusMessageEl.classList.add("status-error");
        if (isSuccess) statusMessageEl.classList.add("status-success");
      }

      async function fetchMenus() {
        const { data, error } = await supabaseClient
          .from("menus")
          .select("*")
          .order("name", { ascending: true });

        if (error) {
          console.error("Error fetching menus:", error);
          return [];
        }

        return data || [];
      }

      async function fetchMenuItems(menuId) {
        // For now, we load drinks directly from the drinks table.
        const { data, error } = await supabaseClient
          .from("drinks")
          .select("*, categories(name)")
          .order("name", { ascending: true });

        if (error) {
          console.error("Error fetching drinks for menu:", error);
          return [];
        }

        return data || [];
      }

      async function fetchMenuSyrups(menuId) {
        const { data, error } = await supabaseClient
          .from("syrups")
          .select("*")
          .eq("menu_id", menuId)
          .order("name", { ascending: true });

        if (error) {
          console.error("Error fetching syrups:", error);
          return [];
        }

        return data || [];
      }

      function groupDrinksByCategory(drinks) {
        const grouped = {};
        for (const drink of drinks) {
          const category =
            (drink.categories && drink.categories.name) || "Other";
          if (!grouped[category]) grouped[category] = [];
          grouped[category].push(drink);
        }
        return grouped;
      }

      function renderMenu() {
        menuContainerEl.innerHTML = "";

        if (!currentMenu || currentMenuDrinks.length === 0) {
          menuContainerEl.innerHTML =
            '<p class="menu-empty-text">This menu has no drinks yet.</p>';
          return;
        }

        const grouped = groupDrinksByCategory(currentMenuDrinks);

        for (const [categoryName, items] of Object.entries(grouped)) {
const categoryDiv = document.createElement("div");
categoryDiv.className = "menu-category collapsed"; // default collapsed


          // Header (clickable)
          const header = document.createElement("div");
          header.className = "menu-category-header";

          const title = document.createElement("h3");
          title.className = "menu-category-title";
          title.textContent = categoryName;

const chevron = document.createElement("span");
chevron.className = "menu-category-chevron";
chevron.textContent = "▸";


          header.appendChild(title);
          header.appendChild(chevron);

          // Container for drinks
          const drinksContainer = document.createElement("div");
          drinksContainer.className = "menu-drinks-container";

          items.forEach((drink) => {
            const card = document.createElement("div");
            card.className = "drink-card";

            const infoDiv = document.createElement("div");
            infoDiv.className = "drink-info";

            const nameDiv = document.createElement("div");
            nameDiv.className = "drink-name";
            nameDiv.textContent = drink.name;

            const descriptionDiv = document.createElement("div");
            descriptionDiv.className = "drink-description";
            descriptionDiv.textContent = drink.description || "";

            infoDiv.appendChild(nameDiv);
            if (drink.description) infoDiv.appendChild(descriptionDiv);

            const actionsDiv = document.createElement("div");
            actionsDiv.className = "drink-actions";

            const button = document.createElement("button");
            button.type = "button";
            button.className = "btn-select";
            button.textContent = "Select";
            button.onclick = () => {
              drinkSelectEl.value = drink.id;
            };

            actionsDiv.appendChild(button);

            card.appendChild(infoDiv);
            card.appendChild(actionsDiv);

            drinksContainer.appendChild(card);
          });

          // Toggle behaviour
          header.addEventListener("click", () => {
            const isCollapsed = categoryDiv.classList.toggle("collapsed");
            chevron.textContent = isCollapsed ? "▸" : "▾";
          });

          categoryDiv.appendChild(header);
          categoryDiv.appendChild(drinksContainer);
          menuContainerEl.appendChild(categoryDiv);
        }
      }

      function renderDrinkSelect() {
        drinkSelectEl.innerHTML = "";

        if (!currentMenuDrinks || currentMenuDrinks.length === 0) {
          const opt = document.createElement("option");
          opt.value = "";
          opt.textContent = "No drinks available";
          drinkSelectEl.appendChild(opt);
          drinkSelectEl.disabled = true;
          return;
        }

        drinkSelectEl.disabled = false;

        const defaultOpt = document.createElement("option");
        defaultOpt.value = "";
        defaultOpt.textContent = "Select a drink";
        drinkSelectEl.appendChild(defaultOpt);

        const drinksSorted = [...currentMenuDrinks].sort((a, b) =>
          a.name.localeCompare(b.name)
        );

        for (const drink of drinksSorted) {
          const opt = document.createElement("option");
          opt.value = drink.id;
          opt.textContent = drink.name;
          drinkSelectEl.appendChild(opt);
        }
      }

      function renderSyrupFlavourSelect() {
        syrupFlavourSelect.innerHTML = "";

        const syrupChoice = Array.from(syrupChoiceRadios).find(
          (r) => r.checked
        )?.value;

        if (syrupChoice !== "yes") {
          const opt = document.createElement("option");
          opt.value = "";
          opt.textContent = "No syrup selected";
          syrupFlavourSelect.appendChild(opt);
          syrupFlavourSelect.disabled = true;
          return;
        }

        if (!currentMenuSyrups || currentMenuSyrups.length === 0) {
          const opt = document.createElement("option");
          opt.value = "";
          opt.textContent = "No syrups available";
          syrupFlavourSelect.appendChild(opt);
          syrupFlavourSelect.disabled = true;
          return;
        }

        syrupFlavourSelect.disabled = false;

        const defaultOpt = document.createElement("option");
        defaultOpt.value = "";
        defaultOpt.textContent = "Select a flavour";
        syrupFlavourSelect.appendChild(defaultOpt);

        currentMenuSyrups.forEach((s) => {
          const opt = document.createElement("option");
          opt.value = s.name;
          opt.textContent = s.name;
          syrupFlavourSelect.appendChild(opt);
        });
      }

      function handleSyrupChoiceChange() {
        renderSyrupFlavourSelect();
      }

      syrupChoiceRadios.forEach((radio) => {
        radio.addEventListener("change", handleSyrupChoiceChange);
      });

      async function handleMenuChange() {
        const menuId = menuSelectEl.value;
        if (!menuId) {
          currentMenu = null;
          currentMenuDrinks = [];
          currentMenuSyrups = [];
          menuTitleEl.textContent = "Menu";
          menuDescriptionEl.textContent = "";
          menuLastUpdatedEl.textContent = "";
          renderMenu();
          renderDrinkSelect();
          renderSyrupFlavourSelect();
          return;
        }

        const selectedOption = menuSelectEl.selectedOptions[0];
        currentMenu = {
          id: menuId,
          name: selectedOption.dataset.menuName,
          description: selectedOption.dataset.menuDescription,
          last_updated: selectedOption.dataset.menuLastUpdated
        };

        menuTitleEl.textContent = currentMenu.name || "Menu";
        menuDescriptionEl.textContent =
          currentMenu.description || "Browse the drinks below.";

        if (currentMenu.last_updated) {
          const lastUpdatedDate = new Date(currentMenu.last_updated);
          if (!isNaN(lastUpdatedDate.getTime())) {
            menuLastUpdatedEl.textContent = `Last updated: ${lastUpdatedDate.toLocaleString()}`;
          } else {
            menuLastUpdatedEl.textContent = "";
          }
        } else {
          menuLastUpdatedEl.textContent = "";
        }

        currentMenuDrinks = await fetchMenuItems(menuId);
        currentMenuSyrups = await fetchMenuSyrups(menuId);

        renderMenu();
        renderDrinkSelect();
        renderSyrupFlavourSelect();
      }

      menuSelectEl.addEventListener("change", handleMenuChange);

      async function handleOrderSubmit(e) {
        e.preventDefault();
        setStatus("");
        submitOrderBtn.disabled = true;

        try {
          if (!currentMenu) {
            setStatus("No menu is selected.", true);
            return;
          }

          const customerName = customerNameInput.value.trim();
          const drinkId = drinkSelectEl.value;
          const selectedMilk = milkSelect.value || null;
          const syrupChoice = Array.from(syrupChoiceRadios).find(
            (r) => r.checked
          )?.value;
          const icedChoice = Array.from(icedChoiceRadios).find(
            (r) => r.checked
          )?.value;
          const syrupFlavour =
            syrupChoice === "yes" ? syrupFlavourSelect.value || null : null;
          const notes = notesInput.value.trim() || null;

          if (!customerName) {
            setStatus("Please enter your name.", true);
            return;
          }

          if (!drinkId) {
            setStatus("Please select a drink.", true);
            return;
          }

          const drinkItem = currentMenuDrinks.find(
            (drink) => drink.id === drinkId
          );
          if (!drinkItem) {
            setStatus("Selected drink not found. Please refresh.", true);
            return;
          }

          if (syrupChoice === "yes" && !syrupFlavour) {
            setStatus("Please select a syrup flavour.", true);
            return;
          }

          const payload = {
            customer_name: customerName,
            drink: drinkItem.name,
            milk: selectedMilk,
            syrup: syrupChoice === "yes",
            syrup_flavour:
              syrupChoice === "yes" && syrupFlavour ? syrupFlavour : null,
            iced: icedChoice === "yes",
            notes: notes || null
          };

          const { error } = await supabaseClient.from("orders").insert([
            {
              menu_id: currentMenu.id,
              ...payload
            }
          ]);

          if (error) {
            console.error("Error inserting order:", error);
            setStatus("Error submitting order. Please try again.", true);
            return;
          }

          orderForm.reset();
          // Reset defaults (hot, no syrup)
          document.querySelector('input[name="iced"][value="no"]').checked = true;
          document.querySelector('input[name="syrup"][value="no"]').checked = true;
          handleSyrupChoiceChange();

          setStatus("Order submitted successfully!", false, true);
        } catch (err) {
          console.error("Unexpected error submitting order:", err);
          setStatus(
            "Something broke. Not you. Probably the code.",
            true
          );
        } finally {
          submitOrderBtn.disabled = false;
        }
      }

      orderForm.addEventListener("submit", handleOrderSubmit);

      async function init() {
        setStatus("");
        menuContainerEl.innerHTML =
          "<p>Loading menu... assuming the espresso machine cooperates.</p>";

        const menus = await fetchMenus();

        menuSelectEl.innerHTML = "";
        const defaultOpt = document.createElement("option");
        defaultOpt.value = "";
        defaultOpt.textContent = "Select a menu";
        menuSelectEl.appendChild(defaultOpt);

        if (!menus || menus.length === 0) {
          menuContainerEl.innerHTML =
            '<p class="menu-empty-text">No menus available yet.</p>';
          drinkSelectEl.innerHTML = "";
          const opt = document.createElement("option");
          opt.value = "";
          opt.textContent = "No drinks available";
          drinkSelectEl.appendChild(opt);
          drinkSelectEl.disabled = true;
          syrupFlavourSelect.innerHTML = "";
          const syrupOpt = document.createElement("option");
          syrupOpt.value = "";
          syrupOpt.textContent = "No syrups available";
          syrupFlavourSelect.appendChild(syrupOpt);
          syrupFlavourSelect.disabled = true;
          return;
        }

        menus.forEach((menu) => {
          const opt = document.createElement("option");
          opt.value = menu.id;
          opt.textContent = menu.name || "Untitled menu";
          opt.dataset.menuName = menu.name || "Untitled menu";
          opt.dataset.menuDescription = menu.description || "";
          opt.dataset.menuLastUpdated = menu.updated_at || "";
          menuSelectEl.appendChild(opt);
        });

        const defaultMenu =
          menus.find((m) => m.is_default) || menus[0] || null;

        if (defaultMenu) {
          menuSelectEl.value = defaultMenu.id;
          await handleMenuChange();
        } else {
          currentMenu = null;
          currentMenuDrinks = [];
          currentMenuSyrups = [];
          renderMenu();
          renderDrinkSelect();
          renderSyrupFlavourSelect();
        }

        handleSyrupChoiceChange();
      }

      init();
    </script>
  </body>
</html>
