<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Nathan's Coffee Menu</title>
    <style>
      body {
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
          sans-serif;
        margin: 0;
        padding: 0;
        background-color: #f5f5f5;
        color: #333;
      }
      header {
        background-color: #333;
        color: #fff;
        padding: 1rem;
        text-align: center;
      }
      main {
        padding: 1rem;
        max-width: 900px;
        margin: 0 auto;
      }
      h1,
      h2,
      h3 {
        margin-bottom: 0.5rem;
      }
      .section {
        background: #fff;
        margin-bottom: 1.5rem;
        padding: 1rem;
        border-radius: 6px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
      }
      .menu-category {
        margin-bottom: 1rem;
      }
      .drink-card {
        border: 1px solid #ddd;
        border-radius: 4px;
        padding: 0.75rem;
        margin-bottom: 0.75rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      .drink-info {
        flex: 1;
      }
      .drink-name {
        font-weight: 600;
        margin-bottom: 0.25rem;
      }
      .drink-description {
        font-size: 0.9rem;
        color: #555;
      }
      .drink-price {
        margin-top: 0.25rem;
        font-size: 0.9rem;
        color: #333;
      }
      .drink-actions {
        margin-left: 1rem;
      }
      button {
        cursor: pointer;
      }
      .order-form-group {
        margin-bottom: 0.75rem;
      }
      label {
        display: block;
        font-weight: 600;
        margin-bottom: 0.25rem;
      }
      input,
      select,
      textarea {
        width: 100%;
        padding: 6px 8px;
        font-size: 0.95rem;
        border-radius: 4px;
        border: 1px solid #ccc;
        box-sizing: border-box;
      }
      textarea {
        resize: vertical;
      }
      #status-message {
        margin-top: 8px;
        font-size: 0.9rem;
      }
      .status-success {
        color: #2f855a;
      }
      .status-error {
        color: #c53030;
      }
      .nav {
        display: flex;
        justify-content: flex-end;
        align-items: center;
        margin-bottom: 1rem;
        gap: 0.25rem;
      }
      .nav button {
        padding: 0.35rem 0.75rem;
        font-size: 0.85rem;
        border-radius: 999px;
        border: 1px solid #ddd;
        background: #f7f7f7;
      }
      .nav button.active {
        background: #333;
        color: white;
        border-color: #333;
      }
      .menu-selector {
        margin-bottom: 1rem;
      }
      .menu-selector select {
        width: auto;
        min-width: 200px;
      }
      .syrup-flavour-select {
        max-width: 250px;
      }
      .small-note {
        font-size: 0.8rem;
        color: #666;
        margin-top: 0.25rem;
      }
      .inline-radio-group {
        display: flex;
        gap: 0.75rem;
        align-items: center;
        flex-wrap: wrap;
      }
      .inline-radio-group label {
        font-weight: 400;
        display: inline-flex;
        align-items: center;
        gap: 0.25rem;
        margin: 0;
      }
      .inline-radio-group input[type="radio"] {
        width: auto;
      }
      .milk-select {
        max-width: 220px;
      }
      .iced-select-group {
        display: flex;
        gap: 0.75rem;
        flex-wrap: wrap;
      }
      .iced-select-group label {
        font-weight: 400;
        display: inline-flex;
        align-items: center;
        gap: 0.25rem;
        margin: 0;
      }
      .iced-select-group input[type="radio"] {
        width: auto;
      }
      .submit-area {
        margin-top: 1rem;
        display: flex;
        flex-direction: column;
        align-items: flex-start;
        gap: 0.25rem;
      }
      .submit-area button[type="submit"] {
        background: #3182ce;
        color: #fff;
        border: none;
        padding: 0.5rem 1rem;
        border-radius: 4px;
        font-size: 0.95rem;
      }
      .submit-area button[type="submit"]:disabled {
        background: #a0aec0;
        cursor: default;
      }
      .menu-description {
        font-size: 0.9rem;
        color: #555;
        margin-bottom: 0.75rem;
      }
      .menu-title-row {
        display: flex;
        justify-content: space-between;
        align-items: baseline;
        gap: 0.5rem;
      }
      .menu-title-row h2 {
        margin: 0;
      }
      .menu-empty-text {
        font-size: 0.9rem;
        color: #777;
        font-style: italic;
      }
      .menu-drinks-container {
        margin-top: 0.5rem;
      }
      .order-name-note {
        font-size: 0.8rem;
        color: #666;
        margin-top: 0.15rem;
      }
      .menu-selector-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 1rem;
        flex-wrap: wrap;
      }
      .menu-selector-row span {
        font-size: 0.85rem;
        color: #666;
      }
      @media (max-width: 600px) {
        .drink-card {
          flex-direction: column;
          align-items: flex-start;
        }
        .drink-actions {
          margin-left: 0;
          margin-top: 0.5rem;
        }
        .menu-selector-row {
          flex-direction: column;
          align-items: flex-start;
        }
      }
    </style>
  </head>
  <body>
    <header>
      <h1>Nathan's Coffee Menu</h1>
    </header>

    <main>
      <div class="nav">
        <button
          class="active"
          type="button"
          onclick="window.location.href='index.html'"
        >
          Guest view
        </button>
        <button type="button" onclick="window.location.href='host.html'">
          Host view
        </button>
      </div>

      <section class="section" id="menu-section">
        <div class="menu-selector">
          <div class="menu-selector-row">
            <div>
              <label for="menu-select">Select a menu:</label>
              <select id="menu-select"></select>
            </div>
            <span id="menu-last-updated"></span>
          </div>
        </div>

        <div class="menu-header">
          <div class="menu-title-row">
            <h2 id="menu-title">Menu</h2>
          </div>
          <p id="menu-description" class="menu-description"></p>
        </div>

        <div id="menu-container"></div>
      </section>

      <section class="section" id="order-section">
        <h2>Place your order</h2>
        <form id="order-form">
          <div class="order-form-group">
            <label for="customer-name-input">Your name</label>
            <input
              type="text"
              id="customer-name-input"
              placeholder="What should we call out?"
              required
            />
            <div class="order-name-note">
              If you skip this, your coffee might be “Mysterious Stranger”.
            </div>
          </div>

          <div class="order-form-group">
            <label for="drink-select">Drink</label>
            <select id="drink-select" required></select>
          </div>

          <div class="order-form-group">
            <label for="milk-select">Milk</label>
            <select id="milk-select" class="milk-select">
              <option value="Whole">Whole</option>
              <option value="2%">2%</option>
              <option value="Skim">Skim</option>
              <option value="Oat">Oat</option>
              <option value="Almond">Almond</option>
              <option value="Soy">Soy</option>
            </select>
          </div>

          <div class="order-form-group">
            <label>Syrup?</label>
            <div class="inline-radio-group">
              <label>
                <input type="radio" name="syrup-choice" value="no" checked />
                No
              </label>
              <label>
                <input type="radio" name="syrup-choice" value="yes" />
                Yes
              </label>
            </div>
            <div
              id="syrup-flavour-container"
              class="syrup-flavour-select"
              style="margin-top: 0.5rem; display: none;"
            >
              <label for="syrup-flavour-select">Syrup flavour</label>
              <select id="syrup-flavour-select"></select>
            </div>
            <div class="small-note">
              Syrup flavours depend on what the host has on the bar right now.
            </div>
          </div>

          <div class="order-form-group">
            <label>Iced?</label>
            <div class="inline-radio-group">
              <label>
                <input type="radio" name="iced-choice" value="no" checked />
                No
              </label>
              <label>
                <input type="radio" name="iced-choice" value="yes" />
                Yes
              </label>
            </div>
          </div>

          <div class="order-form-group">
            <label for="notes-input">Special requests / notes</label>
            <textarea
              id="notes-input"
              rows="3"
              placeholder="Extra hot, less ice, no judgement…"
            ></textarea>
          </div>

          <div class="submit-area">
            <button type="submit" id="submit-order-btn">Submit order</button>
            <span id="status-message"></span>
          </div>
        </form>
      </section>
    </main>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
      // ===== Supabase config =====
      const SUPABASE_URL = "https://cyfdiuyjzcrommxldpwp.supabase.co";
      const SUPABASE_ANON_KEY =
        "sb_publishable_hzG6hrSF4DBFz9FrGC-Ghw_MSbQCHFo.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNjZmp1c2ZvdW1tbnljc3d4bHZpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzM1ODQwNTMsImV4cCI6MjA0OTE2MDA1M30.Z7zNaLqwVENVfwE1E-Y3Ne0nfnpQ1g4KA0UOGHIN6Bc";

      const supabaseClient = window.supabase.createClient(
        SUPABASE_URL,
        SUPABASE_ANON_KEY
      );

      console.log("Supabase initialised", SUPABASE_URL);

      // ===== DOM elements =====
      const menuSelectEl = document.getElementById("menu-select");
      const menuContainerEl = document.getElementById("menu-container");
      const drinkSelectEl = document.getElementById("drink-select");
      const menuTitleEl = document.getElementById("menu-title");
      const menuDescriptionEl = document.getElementById("menu-description");
      const menuLastUpdatedEl = document.getElementById("menu-last-updated");

      const syrupChoiceRadios = document.querySelectorAll(
        'input[name="syrup-choice"]'
      );
      const syrupFlavourContainer = document.getElementById(
        "syrup-flavour-container"
      );
      const syrupFlavourSelect = document.getElementById("syrup-flavour-select");
      const icedChoiceRadios = document.querySelectorAll(
        'input[name="iced-choice"]'
      );

      const orderForm = document.getElementById("order-form");
      const customerNameInput = document.getElementById("customer-name-input");
      const milkSelect = document.getElementById("milk-select");
      const notesInput = document.getElementById("notes-input");
      const submitOrderBtn = document.getElementById("submit-order-btn");
      const statusMessageEl = document.getElementById("status-message");

      let currentMenu = null;
      let currentMenuDrinks = [];
      let currentMenuSyrups = [];

      // ===== Helpers =====
      function setStatus(message, isError = false) {
        statusMessageEl.textContent = message || "";
        statusMessageEl.className = isError
          ? "status-error"
          : message
          ? "status-success"
          : "";
      }

      function handleSyrupChoiceChange() {
        const selected = Array.from(syrupChoiceRadios).find((r) => r.checked);
        if (!selected) return;

        if (selected.value === "yes") {
          syrupFlavourContainer.style.display = "block";
        } else {
          syrupFlavourContainer.style.display = "none";
          syrupFlavourSelect.value = "";
        }
      }

      syrupChoiceRadios.forEach((radio) => {
        radio.addEventListener("change", handleSyrupChoiceChange);
      });

      // ===== Supabase fetches =====
      async function fetchMenus() {
        const { data, error } = await supabaseClient
          .from("menus")
          .select("*")
          .order("name", { ascending: true });

        if (error) {
          console.error("Error fetching menus:", error);
          return [];
        }

        console.log("Menus fetched:", data);
        return data || [];
      }

      async function fetchMenuItems(menuId) {
        const { data, error } = await supabaseClient
          .from("menu_items")
          .select("*, drinks!inner(name, description, base_price, category)")
          .eq("menu_id", menuId)
          .order("sort_order", { ascending: true });

        if (error) {
          console.error("Error fetching menu items:", error);
          return [];
        }

        console.log("Menu items fetched:", data);
        return data || [];
      }

      async function fetchMenuSyrups(menuId) {
        const { data, error } = await supabaseClient
          .from("syrups")
          .select("*")
          .eq("menu_id", menuId)
          .order("name", { ascending: true });

        if (error) {
          console.error("Error fetching syrups:", error);
          return [];
        }

        console.log("Syrups fetched:", data);
        return data || [];
      }

      // ===== Rendering =====
      function groupDrinksByCategory(menuItems) {
        const grouped = {};
        for (const item of menuItems) {
          const category = item.drinks.category || "Other";
          if (!grouped[category]) grouped[category] = [];
          grouped[category].push(item);
        }
        return grouped;
      }

      function renderMenu() {
        menuContainerEl.innerHTML = "";

        if (!currentMenu || currentMenuDrinks.length === 0) {
          menuContainerEl.innerHTML =
            '<p class="menu-empty-text">This menu has no drinks yet.</p>';
          return;
        }

        const grouped = groupDrinksByCategory(currentMenuDrinks);

        for (const [categoryName, items] of Object.entries(grouped)) {
          const categoryDiv = document.createElement("div");
          categoryDiv.className = "menu-category";

          const h3 = document.createElement("h3");
          h3.textContent = categoryName;
          categoryDiv.appendChild(h3);

          const drinksContainer = document.createElement("div");
          drinksContainer.className = "menu-drinks-container";

          items.forEach((item) => {
            const drink = item.drinks;

            const card = document.createElement("div");
            card.className = "drink-card";

            const infoDiv = document.createElement("div");
            infoDiv.className = "drink-info";

            const nameDiv = document.createElement("div");
            nameDiv.className = "drink-name";
            nameDiv.textContent = drink.name;

            const descriptionDiv = document.createElement("div");
            descriptionDiv.className = "drink-description";
            descriptionDiv.textContent = drink.description || "";

            const priceDiv = document.createElement("div");
            priceDiv.className = "drink-price";
            priceDiv.textContent =
              drink.base_price != null
                ? `$${Number(drink.base_price).toFixed(2)}`
                : "Price TBD";

            infoDiv.appendChild(nameDiv);
            if (drink.description) infoDiv.appendChild(descriptionDiv);
            infoDiv.appendChild(priceDiv);

            const actionsDiv = document.createElement("div");
            actionsDiv.className = "drink-actions";

            const button = document.createElement("button");
            button.type = "button";
            button.textContent = "Select";
            button.onclick = () => {
              drinkSelectEl.value = item.drink_id;
            };

            actionsDiv.appendChild(button);

            card.appendChild(infoDiv);
            card.appendChild(actionsDiv);

            drinksContainer.appendChild(card);
          });

          categoryDiv.appendChild(drinksContainer);
          menuContainerEl.appendChild(categoryDiv);
        }
      }

      function renderDrinkSelect() {
        drinkSelectEl.innerHTML = "";

        if (!currentMenuDrinks || currentMenuDrinks.length === 0) {
          const opt = document.createElement("option");
          opt.value = "";
          opt.textContent = "No drinks available";
          drinkSelectEl.appendChild(opt);
          drinkSelectEl.disabled = true;
          return;
        }

        drinkSelectEl.disabled = false;

        const defaultOpt = document.createElement("option");
        defaultOpt.value = "";
        defaultOpt.textContent = "Select a drink";
        drinkSelectEl.appendChild(defaultOpt);

        const drinksSorted = [...currentMenuDrinks].sort((a, b) =>
          a.drinks.name.localeCompare(b.drinks.name)
        );

        for (const item of drinksSorted) {
          const opt = document.createElement("option");
          opt.value = item.drink_id;
          opt.textContent = item.drinks.name;
          drinkSelectEl.appendChild(opt);
        }
      }

      function renderSyrupFlavourSelect() {
        syrupFlavourSelect.innerHTML = "";

        if (!currentMenuSyrups || currentMenuSyrups.length === 0) {
          const opt = document.createElement("option");
          opt.value = "";
          opt.textContent = "No syrups available";
          syrupFlavourSelect.appendChild(opt);
          syrupFlavourSelect.disabled = true;
          return;
        }

        syrupFlavourSelect.disabled = false;

        const defaultOpt = document.createElement("option");
        defaultOpt.value = "";
        defaultOpt.textContent = "Select a flavour";
        syrupFlavourSelect.appendChild(defaultOpt);

        currentMenuSyrups.forEach((s) => {
          const opt = document.createElement("option");
          opt.value = s.name;
          opt.textContent = s.name;
          syrupFlavourSelect.appendChild(opt);
        });
      }

      // ===== Menu change =====
      async function handleMenuChange() {
        const menuId = menuSelectEl.value;
        if (!menuId) {
          currentMenu = null;
          currentMenuDrinks = [];
          currentMenuSyrups = [];
          menuTitleEl.textContent = "Menu";
          menuDescriptionEl.textContent = "";
          menuLastUpdatedEl.textContent = "";
          renderMenu();
          renderDrinkSelect();
          renderSyrupFlavourSelect();
          return;
        }

        const selectedOption = menuSelectEl.selectedOptions[0];
        currentMenu = {
          id: menuId,
          name: selectedOption.dataset.menuName,
          description: selectedOption.dataset.menuDescription,
          last_updated: selectedOption.dataset.menuLastUpdated
        };

        menuTitleEl.textContent = currentMenu.name || "Menu";
        menuDescriptionEl.textContent =
          currentMenu.description || "Browse the drinks below.";

        if (currentMenu.last_updated) {
          const lastUpdatedDate = new Date(currentMenu.last_updated);
          if (!isNaN(lastUpdatedDate.getTime())) {
            menuLastUpdatedEl.textContent = `Last updated: ${lastUpdatedDate.toLocaleString()}`;
          } else {
            menuLastUpdatedEl.textContent = "";
          }
        } else {
          menuLastUpdatedEl.textContent = "";
        }

        currentMenuDrinks = await fetchMenuItems(menuId);
        currentMenuSyrups = await fetchMenuSyrups(menuId);

        renderMenu();
        renderDrinkSelect();
        renderSyrupFlavourSelect();
      }

      menuSelectEl.addEventListener("change", handleMenuChange);

      // ===== Order submit =====
      async function handleOrderSubmit(e) {
        e.preventDefault();
        setStatus("");
        submitOrderBtn.disabled = true;

        try {
          if (!currentMenu) {
            setStatus("No menu is selected.", true);
            return;
          }

          const customerName = customerNameInput.value.trim();
          const drinkId = drinkSelectEl.value;
          const selectedMilk = milkSelect.value || null;
          const syrupChoice = Array.from(syrupChoiceRadios).find(
            (r) => r.checked
          )?.value;
          const icedChoice = Array.from(icedChoiceRadios).find(
            (r) => r.checked
          )?.value;
          const syrupFlavour =
            syrupChoice === "yes" ? syrupFlavourSelect.value || null : null;
          const notes = notesInput.value.trim() || null;

          if (!customerName) {
            setStatus("Please enter your name.", true);
            return;
          }

          if (!drinkId) {
            setStatus("Please select a drink.", true);
            return;
          }

          const drinkItem = currentMenuDrinks.find(
            (item) => item.drink_id === drinkId
          );
          if (!drinkItem) {
            setStatus("Selected drink not found. Please refresh.", true);
            return;
          }

          if (syrupChoice === "yes" && !syrupFlavour) {
            setStatus("Please select a syrup flavour.", true);
            return;
          }

          const payload = {
            customer_name: customerName,
            drink: drinkItem.drinks.name,
            milk: selectedMilk,
            syrup: syrupChoice === "yes",
            syrup_flavour:
              syrupChoice === "yes" && syrupFlavour ? syrupFlavour : null,
            iced: icedChoice === "yes",
            notes: notes || null
          };

          const { error } = await supabaseClient.from("orders").insert([
            {
              menu_id: currentMenu.id,
              ...payload
            }
          ]);

          if (error) {
            console.error("Error inserting order:", error);
            setStatus(
              "There was a problem placing your order. Please try again.",
              true
            );
            return;
          }

          orderForm.reset();
          handleSyrupChoiceChange();
          setStatus("Order placed! Your drink will be on the way soon.");
        } catch (err) {
          console.error("Unexpected error:", err);
          setStatus(
            "An unexpected error occurred. Please try again later.",
            true
          );
        } finally {
          submitOrderBtn.disabled = false;
        }
      }

      orderForm.addEventListener("submit", handleOrderSubmit);

      // ===== Init =====
      async function init() {
        setStatus("");
        menuContainerEl.innerHTML =
          "<p>Loading menu... assuming the espresso machine cooperates.</p>";

        const menus = await fetchMenus();

        menuSelectEl.innerHTML = "";
        const defaultOpt = document.createElement("option");
        defaultOpt.value = "";
        defaultOpt.textContent = "Select a menu";
        menuSelectEl.appendChild(defaultOpt);

        if (!menus || menus.length === 0) {
          menuContainerEl.innerHTML =
            '<p class="menu-empty-text">No menus available yet.</p>';
          drinkSelectEl.innerHTML = "";
          const opt = document.createElement("option");
          opt.value = "";
          opt.textContent = "No drinks available";
          drinkSelectEl.appendChild(opt);
          drinkSelectEl.disabled = true;
          syrupFlavourSelect.innerHTML = "";
          const syrupOpt = document.createElement("option");
          syrupOpt.value = "";
          syrupOpt.textContent = "No syrups available";
          syrupFlavourSelect.appendChild(syrupOpt);
          syrupFlavourSelect.disabled = true;
          return;
        }

        menus.forEach((menu) => {
          const opt = document.createElement("option");
          opt.value = menu.id;
          opt.textContent = menu.name || "Untitled menu";
          opt.dataset.menuName = menu.name || "Untitled menu";
          opt.dataset.menuDescription = menu.description || "";
          opt.dataset.menuLastUpdated = menu.updated_at || "";
          menuSelectEl.appendChild(opt);
        });

        const defaultMenu =
          menus.find((m) => m.is_default) || menus[0] || null;

        if (defaultMenu) {
          menuSelectEl.value = defaultMenu.id;
          await handleMenuChange();
        } else {
          currentMenu = null;
          currentMenuDrinks = [];
          currentMenuSyrups = [];
          renderMenu();
          renderDrinkSelect();
          renderSyrupFlavourSelect();
        }

        handleSyrupChoiceChange();
      }

      init();
    </script>
  </body>
</html>
