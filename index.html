<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Thistle & Cherry Blossom</title>
<style>
  :root {
    --bg-body: #020617;
    --bg-page: #020617;
    --bg-card: #020617;
    --bg-elevated: #020617;
    --border-subtle: #1f2937;
    --border-strong: #4b5563;

    --text-main: #e5e7eb;
    --text-muted: #9ca3af;

    --accent: #a855f7;
    --accent-strong: #c4b5fd;
    --accent-soft: #111827;

    --danger: #fca5a5;
    --success: #6ee7b7;
  }

  * {
    box-sizing: border-box;
  }

  body {
    font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
      sans-serif;
    margin: 0;
    padding: 0;
    background: radial-gradient(
      circle at top left,
      #020617 0,
      #020617 55%,
      #0f172a 100%
    );
    color: var(--text-main);
    min-height: 100vh;
  }

  header {
    background-color: #020617;
    color: var(--text-main);
    padding: 0.9rem 1.25rem;
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    gap: 0.75rem;
    border-bottom: 1px solid #111827;
    box-shadow: 0 14px 40px rgba(0, 0, 0, 0.8);
    position: sticky;
    top: 0;
    z-index: 10;
  }

  .header-main {
    display: flex;
    flex-direction: column;
    gap: 0.2rem;
  }

  header h1 {
    margin: 0;
    font-size: 1.35rem;
    letter-spacing: 0.04em;
  }

  header p {
    margin: 0;
    font-size: 0.85rem;
    color: var(--text-muted);
  }

  .header-nav a {
    font-size: 0.75rem;
    text-decoration: none;
    color: var(--text-main);
    background-color: #020617;
    padding: 0.3rem 0.75rem;
    border-radius: 999px;
    border: 1px solid var(--border-strong);
    display: inline-flex;
    align-items: center;
    gap: 0.35rem;
    transition: background-color 0.15s ease, border-color 0.15s ease,
      transform 0.1s ease;
  }

  .header-nav a::before {
    content: "☕";
    font-size: 0.8rem;
  }

  .header-nav a:hover {
    background-color: #111827;
    border-color: #9ca3af;
    transform: translateY(-1px);
  }

  main {
    padding: 1.25rem 1rem 1.75rem;
    max-width: 900px;
    margin: 0 auto;
  }

  h1,
  h2,
  h3 {
    margin-bottom: 0.4rem;
  }

  .section {
    background: var(--bg-card);
    margin-bottom: 1.25rem;
    padding: 1rem 1.1rem;
    border-radius: 14px;
    border: 1px solid var(--border-subtle);
    box-shadow: 0 18px 45px rgba(0, 0, 0, 0.7);
    position: relative;
    overflow: hidden;
  }

  .section::before {
    content: "";
    position: absolute;
    inset-inline: 0.9rem;
    top: 0;
    height: 3px;
    border-radius: 999px;
    background: linear-gradient(90deg, #7c3aed, #ec4899);
    opacity: 0.7;
  }

  .menu-select-row {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    margin-bottom: 0.8rem;
    flex-wrap: wrap;
  }

  .menu-select-row label {
    font-size: 0.85rem;
    color: var(--text-muted);
  }

  .menu-select-row select {
    padding: 0.32rem 0.6rem;
    font-size: 0.9rem;
    border-radius: 999px;
    border: 1px solid var(--border-subtle);
    background: #020617;
    color: var(--text-main);
    outline: none;
    min-width: 150px;
    transition: border-color 0.15s ease, box-shadow 0.15s ease,
      background 0.15s ease;
  }

  .menu-select-row select:focus {
    border-color: var(--accent);
    box-shadow: 0 0 0 1px rgba(168, 85, 247, 0.55);
    background: #020617;
  }

  .menu-header {
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
  }

  .menu-header-title-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 0.5rem;
  }

  .menu-last-updated {
    font-size: 0.8rem;
    color: var(--text-muted);
    white-space: nowrap;
  }

  .menu-description {
    font-size: 0.9rem;
    color: var(--text-muted);
    margin: 0;
  }

  .status-message {
    font-size: 0.8rem;
    color: var(--text-muted);
  }

  .status-error {
    color: var(--danger);
  }

  .status-success {
    color: var(--success);
  }

  .menu-empty-text {
    font-size: 0.9rem;
    color: var(--text-muted);
    font-style: italic;
  }

  /* Specials section – always visible, squares at the top */

  .specials-section {
    margin-bottom: 0.9rem;
    padding: 0.75rem 0.1rem 0.1rem;
    border-radius: 12px;
    background: radial-gradient(circle at top left, #111827 0, #020617 60%);
    border: 1px solid rgba(148, 163, 184, 0.35);
  }

  .specials-header {
    display: flex;
    justify-content: space-between;
    align-items: baseline;
    padding: 0 0.3rem 0.4rem;
  }

  .specials-title {
    margin: 0;
    font-size: 0.95rem;
    letter-spacing: 0.04em;
    text-transform: uppercase;
    color: var(--accent-strong);
  }

  .specials-badge {
    font-size: 0.7rem;
    padding: 0.1rem 0.5rem;
    border-radius: 999px;
    border: 1px solid rgba(168, 85, 247, 0.6);
    color: var(--accent-strong);
    background: rgba(15, 23, 42, 0.9);
  }

  .specials-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
    gap: 0.6rem;
    padding: 0.1rem 0.1rem 0.2rem;
  }

  .special-card {
    border-radius: 12px;
    background: #020617;
    border: 1px solid rgba(148, 163, 184, 0.5);
    padding: 0.7rem 0.7rem 0.6rem;
    min-height: 120px;
    display: flex;
    flex-direction: column;
    justify-content: space-between;
    box-shadow: 0 12px 30px rgba(0, 0, 0, 0.75);
    transition: transform 0.1s ease, box-shadow 0.15s ease,
      border-color 0.15s ease;
  }

  .special-card:hover {
    transform: translateY(-1px);
    box-shadow: 0 18px 45px rgba(0, 0, 0, 0.9);
    border-color: rgba(168, 85, 247, 0.7);
  }

  .special-card-top {
    display: flex;
    flex-direction: column;
    gap: 0.15rem;
    margin-bottom: 0.2rem;
  }

  .special-card-category {
    font-size: 0.68rem;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    color: var(--text-muted);
  }

  .special-card-name {
    font-size: 0.95rem;
    font-weight: 600;
  }

  .special-card-description {
    font-size: 0.8rem;
    color: var(--text-muted);
    margin-top: 0.2rem;
    flex: 1;
  }

  .special-card-bottom {
    display: flex;
    justify-content: flex-end;
    margin-top: 0.4rem;
  }

  .btn-special-select {
    border-radius: 999px;
    border: 1px solid rgba(168, 85, 247, 0.7);
    background: #111827;
    color: var(--accent-strong);
    font-size: 0.78rem;
    padding: 0.25rem 0.7rem;
    cursor: pointer;
    display: inline-flex;
    align-items: center;
    gap: 0.25rem;
    transition: background 0.15s ease, border-color 0.15s ease,
      transform 0.1s ease;
  }

  .btn-special-select::before {
    content: "★";
    font-size: 0.7rem;
  }

  .btn-special-select:hover {
    background: #1f2937;
    border-color: rgba(196, 181, 253, 0.95);
    transform: translateY(-1px);
  }

  /* Category list (below specials, still collapsible) */

  .menu-category {
    margin-top: 0.75rem;
    border: 1px solid var(--border-subtle);
    border-radius: 10px;
    overflow: hidden;
    background: #020617;
  }

  .menu-category-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0.45rem 0.7rem;
    cursor: pointer;
    background: #020617;
    border-bottom: 1px solid var(--border-subtle);
  }

  .menu-category-header:hover {
    background: #111827;
  }

  .menu-category-title {
    margin: 0;
    font-size: 0.9rem;
    font-weight: 600;
  }

  .menu-category-chevron {
    font-size: 0.85rem;
    opacity: 0.7;
  }

  .menu-drinks-container {
    padding: 0.45rem 0.7rem 0.6rem;
  }

  .menu-category.collapsed .menu-drinks-container {
    display: none;
  }

  .drink-card {
    border-radius: 10px;
    border: 1px solid var(--border-subtle);
    padding: 0.6rem 0.7rem;
    margin-bottom: 0.55rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 0.6rem;
    background: #020617;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.7);
    transition: box-shadow 0.15s ease, transform 0.1s ease,
      border-color 0.15s ease;
  }

  .drink-card:hover {
    box-shadow: 0 16px 40px rgba(0, 0, 0, 0.9);
    transform: translateY(-1px);
    border-color: rgba(168, 85, 247, 0.65);
  }

  .drink-info {
    flex: 1;
  }

  .drink-name {
    font-weight: 600;
    margin-bottom: 0.12rem;
  }

  .drink-description {
    font-size: 0.83rem;
    color: var(--text-muted);
  }

  .drink-actions {
    display: flex;
    align-items: center;
  }

  .btn-select {
    padding: 0.28rem 0.6rem;
    font-size: 0.78rem;
    border-radius: 999px;
    border: 1px solid rgba(148, 163, 184, 0.7);
    background: #020617;
    color: var(--text-main);
    cursor: pointer;
    display: inline-flex;
    align-items: center;
    gap: 0.25rem;
    transition: background 0.15s ease, border-color 0.15s ease,
      transform 0.1s ease;
  }

  .btn-select::before {
    content: "➕";
    font-size: 0.7rem;
  }

  .btn-select:hover {
    background: #111827;
    border-color: rgba(209, 213, 219, 0.9);
    transform: translateY(-1px);
  }

  /* Order form */

  .order-section-header {
    display: flex;
    justify-content: space-between;
    align-items: baseline;
    margin-bottom: 0.5rem;
    gap: 0.5rem;
    flex-wrap: wrap;
  }

  .order-section-header p {
    margin: 0;
    font-size: 0.85rem;
    color: var(--text-muted);
  }

  .form-row {
    margin-bottom: 0.8rem;
  }

  .form-row label {
    display: block;
    font-size: 0.9rem;
    margin-bottom: 0.25rem;
  }

  .form-row input,
  .form-row select,
  .form-row textarea {
    width: 100%;
    box-sizing: border-box;
    padding: 0.4rem 0.45rem;
    font-size: 0.9rem;
    border-radius: 8px;
    border: 1px solid var(--border-subtle);
    background: #020617;
    color: var(--text-main);
    outline: none;
    transition: border-color 0.15s ease, box-shadow 0.15s ease,
      background 0.15s ease;
  }

  .form-row textarea {
    resize: vertical;
    min-height: 72px;
  }

  .form-row input:focus,
  .form-row select:focus,
  .form-row textarea:focus {
    border-color: var(--accent);
    box-shadow: 0 0 0 1px rgba(168, 85, 247, 0.6);
    background: #020617;
  }

  .order-name-note {
    font-size: 0.78rem;
    color: var(--text-muted);
    margin-top: 0.2rem;
  }

  .form-row-inline {
    display: block;
  }

  .radio-group {
    display: flex;
    gap: 0.85rem;
    flex-wrap: wrap;
    font-size: 0.88rem;
  }

  .radio-group label {
    display: inline-flex;
    align-items: center;
    gap: 0.25rem;
  }

  .radio-group input[type="radio"] {
    accent-color: var(--accent);
  }

  .btn-primary {
    background: linear-gradient(135deg, #7c3aed, #ec4899);
    color: #f9fafb;
    border-radius: 999px;
    border: none;
    padding: 0.45rem 1.1rem;
    font-size: 0.9rem;
    cursor: pointer;
    display: inline-flex;
    align-items: center;
    gap: 0.35rem;
    box-shadow: 0 12px 30px rgba(124, 58, 237, 0.6);
    transition: transform 0.1s ease, box-shadow 0.15s ease,
      filter 0.15s ease;
  }

  .btn-primary::before {
    content: "➤";
    font-size: 0.8rem;
  }

  .btn-primary:hover:not(:disabled) {
    transform: translateY(-1px);
    box-shadow: 0 18px 40px rgba(124, 58, 237, 0.8);
    filter: brightness(1.03);
  }

  .btn-primary:disabled {
    opacity: 0.6;
    cursor: default;
    box-shadow: none;
  }

  .form-row.actions-row {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    flex-wrap: wrap;
  }

  @media (max-width: 600px) {
    header {
      padding-inline: 0.85rem;
    }

    main {
      padding-inline: 0.75rem;
    }

    .section {
      padding-inline: 0.9rem;
    }

    .menu-header-title-row {
      flex-direction: column;
      align-items: flex-start;
    }

    .specials-grid {
      grid-template-columns: repeat(auto-fit, minmax(130px, 1fr));
    }

    .drink-card {
      flex-direction: column;
      align-items: flex-start;
    }

    .drink-actions {
      align-self: stretch;
      justify-content: flex-end;
    }

    .btn-primary {
      width: 100%;
      justify-content: center;
    }
  }
</style>


  </head>
  <body>
    <header>
      <div class="header-main">
        <h1>Thistle and Cherry Blossom</h1>
        <p>Pick a drink, add your preferences, submit. No tipping prompt, you’re welcome.</p>
      </div>
      <nav class="header-nav">
        <a href="host.html">Host view</a>
      </nav>
    </header>

    <main>
      <section class="section">
        <div class="menu-select-row">
          <label for="menu-select">Menu:</label>
          <select id="menu-select"></select>
          <span id="menu-status" class="status-message"></span>
        </div>

        <div class="menu-header">
          <div class="menu-header-title-row">
            <h2 id="menu-title">Menu</h2>
            <span id="menu-last-updated" class="menu-last-updated"></span>
          </div>
          <p id="menu-description" class="menu-description">
            Browse the drinks below.
          </p>
        </div>

        <div id="menu-container" style="margin-top: 0.75rem;"></div>
      </section>

      <section class="section">
        <div class="order-section-header">
          <h2>Place an order</h2>
          <p>This creates an order on the host view. No payment, just chaos.</p>
        </div>

        <form id="order-form">
          <div class="form-row">
            <label for="customer-name-input">Your name</label>
            <input
              id="customer-name-input"
              type="text"
              placeholder="Name they'll yell out"
              required
            />
            <div class="order-name-note">
              Use something they’ll recognise. “Latte Goblin” is acceptable.
            </div>
          </div>

          <div class="form-row">
            <label for="drink-select">Drink</label>
            <select id="drink-select" required>
              <option value="">Loading drinks…</option>
            </select>
          </div>

          <!-- Vertical: milk + iced -->
          <div class="form-row-inline">
            <div class="form-row">
              <label for="milk-select">Milk</label>
              <select id="milk-select">
                <option value="">None / default</option>
                <option value="Whole">Whole</option>
                <option value="Skim">Skim</option>
                <option value="Oat">Oat</option>
                <option value="Almond">Almond</option>
                <option value="Soy">Soy</option>
              </select>
            </div>
            <div class="form-row">
              <label>Iced?</label>
              <div class="radio-group" id="iced-group">
                <label>
                  <input type="radio" name="iced" value="no" checked />
                  Hot
                </label>
                <label>
                  <input type="radio" name="iced" value="yes" />
                  Iced
                </label>
              </div>
            </div>
          </div>

          <!-- Vertical: syrup choice + flavour -->
          <div class="form-row-inline">
            <div class="form-row">
              <label>Add syrup?</label>
              <div class="radio-group" id="syrup-group">
                <label>
                  <input type="radio" name="syrup" value="no" checked />
                  No syrup
                </label>
                <label>
                  <input type="radio" name="syrup" value="yes" />
                  Add syrup
                </label>
              </div>
            </div>
            <div class="form-row">
              <label for="syrup-flavour-select">Syrup flavour</label>
              <select id="syrup-flavour-select" disabled>
                <option value="">Select a flavour</option>
              </select>
            </div>
          </div>

          <div class="form-row">
            <label for="notes-input">Notes</label>
            <textarea
              id="notes-input"
              placeholder="Extra hot, less ice, single shot, etc."
            ></textarea>
          </div>

          <div class="form-row" style="display: flex; align-items: center; gap: 0.75rem;">
            <button type="submit" class="btn-primary" id="submit-order-btn">
              Submit order
            </button>
            <span id="status-message" class="status-message"></span>
          </div>
        </form>
      </section>
    </main>

    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script>
      // Hard-coded Supabase credentials – must match host.html
      const SUPABASE_URL = "https://cyfdiuyjzcrommxldpwp.supabase.co";
      const SUPABASE_KEY = "sb_publishable_hzG6hrSF4DBFz9FrGC-Ghw_MSbQCHFo";

      const supabaseClient = window.supabase.createClient(
        SUPABASE_URL,
        SUPABASE_KEY
      );

      const menuSelectEl = document.getElementById("menu-select");
      const menuStatusEl = document.getElementById("menu-status");
      const menuContainerEl = document.getElementById("menu-container");
      const menuTitleEl = document.getElementById("menu-title");
      const menuDescriptionEl = document.getElementById("menu-description");
      const menuLastUpdatedEl = document.getElementById("menu-last-updated");

      const orderForm = document.getElementById("order-form");
      const customerNameInput = document.getElementById("customer-name-input");
      const drinkSelectEl = document.getElementById("drink-select");
      const milkSelect = document.getElementById("milk-select");
      const syrupFlavourSelect = document.getElementById("syrup-flavour-select");
      const notesInput = document.getElementById("notes-input");
      const submitOrderBtn = document.getElementById("submit-order-btn");
      const statusMessageEl = document.getElementById("status-message");

      const syrupChoiceRadios = document.querySelectorAll('input[name="syrup"]');
      const icedChoiceRadios = document.querySelectorAll('input[name="iced"]');

      let currentMenu = null;
      let currentMenuDrinks = [];
      let currentMenuSyrups = [];

      function setStatus(message, isError = false, isSuccess = false) {
        statusMessageEl.textContent = message || "";
        statusMessageEl.classList.remove("status-error", "status-success");
        if (isError) statusMessageEl.classList.add("status-error");
        if (isSuccess) statusMessageEl.classList.add("status-success");
      }

      async function fetchMenus() {
        const { data, error } = await supabaseClient
          .from("menus")
          .select("*")
          .order("name", { ascending: true });

        if (error) {
          console.error("Error fetching menus:", error);
          return [];
        }

        return data || [];
      }

      async function fetchMenuItems(menuId) {
        const { data, error } = await supabaseClient
          .from("drinks")
          .select("*, categories(name, sort_order)")
          .order("name", { ascending: true });

        if (error) {
          console.error("Error fetching drinks for menu:", error);
          return [];
        }

        return data || [];
      }

      async function fetchMenuSyrups(menuId) {
        const { data, error } = await supabaseClient
          .from("syrups")
          .select("*")
          .eq("menu_id", menuId)
          .order("name", { ascending: true });

        if (error) {
          console.error("Error fetching syrups:", error);
          return [];
        }

        return data || [];
      }

      // Group drinks by category, track sort order, and return sorted array
      function groupDrinksByCategory(drinks) {
        const grouped = new Map();

        for (const drink of drinks) {
          const catName =
            (drink.categories && drink.categories.name) || "Other";
          const sortOrder =
            (drink.categories && drink.categories.sort_order) ?? 9999;

          if (!grouped.has(catName)) {
            grouped.set(catName, { sortOrder, items: [] });
          }
          grouped.get(catName).items.push(drink);
        }

        return Array.from(grouped.entries()).sort((a, b) => {
          const sa = a[1].sortOrder;
          const sb = b[1].sortOrder;
          if (sa === sb) {
            return a[0].localeCompare(b[0]);
          }
          return sa - sb;
        });
      }

function renderMenu() {
  menuContainerEl.innerHTML = "";

  if (!currentMenu || currentMenuDrinks.length === 0) {
    menuContainerEl.innerHTML =
      '<p class="menu-empty-text">This menu has no drinks yet.</p>';
    return;
  }

  const grouped = groupDrinksByCategory(currentMenuDrinks);

  const specialsGroups = [];
  const otherGroups = [];

  for (const [categoryName, group] of grouped) {
    const nameLower = (categoryName || "").toLowerCase();
    if (nameLower.includes("special")) {
      specialsGroups.push([categoryName, group]);
    } else {
      otherGroups.push([categoryName, group]);
    }
  }

  // Specials at the top, as square cards, always visible
  if (specialsGroups.length > 0) {
    const specialsSection = document.createElement("div");
    specialsSection.className = "specials-section";

    const headerRow = document.createElement("div");
    headerRow.className = "specials-header";

    const specialsTitle = document.createElement("h3");
    specialsTitle.className = "specials-title";
    specialsTitle.textContent = "Specials";

    const specialsBadge = document.createElement("span");
    specialsBadge.className = "specials-badge";
    specialsBadge.textContent = "Featured";

    headerRow.appendChild(specialsTitle);
    headerRow.appendChild(specialsBadge);

    const specialsGrid = document.createElement("div");
    specialsGrid.className = "specials-grid";

    specialsGroups.forEach(([categoryName, group]) => {
      const items = group.items || [];
      items.forEach((drink) => {
        const card = document.createElement("div");
        card.className = "special-card";

        const topRow = document.createElement("div");
        topRow.className = "special-card-top";

        const catLabel = document.createElement("div");
        catLabel.className = "special-card-category";
        catLabel.textContent = categoryName;

        const nameEl = document.createElement("div");
        nameEl.className = "special-card-name";
        nameEl.textContent = drink.name;

        topRow.appendChild(catLabel);
        topRow.appendChild(nameEl);

        const descEl = document.createElement("div");
        descEl.className = "special-card-description";
        descEl.textContent = drink.description || "";

        const bottomRow = document.createElement("div");
        bottomRow.className = "special-card-bottom";

        const button = document.createElement("button");
        button.type = "button";
        button.className = "btn-special-select";
        button.textContent = "Select";
        button.onclick = () => {
          drinkSelectEl.value = drink.id;
        };

        bottomRow.appendChild(button);

        card.appendChild(topRow);
        if (drink.description) {
          card.appendChild(descEl);
        }
        card.appendChild(bottomRow);

        specialsGrid.appendChild(card);
      });
    });

    specialsSection.appendChild(headerRow);
    specialsSection.appendChild(specialsGrid);
    menuContainerEl.appendChild(specialsSection);
  }

  // Normal categories below (collapsed by default, no specials duplicated)
  const categoriesToRender = otherGroups;

  for (const [categoryName, group] of categoriesToRender) {
    const items = group.items || [];

    const categoryDiv = document.createElement("div");
    categoryDiv.className = "menu-category collapsed"; // default collapsed

    const header = document.createElement("div");
    header.className = "menu-category-header";

    const title = document.createElement("h3");
    title.className = "menu-category-title";
    title.textContent = categoryName;

    const chevron = document.createElement("span");
    chevron.className = "menu-category-chevron";
    chevron.textContent = "▸";

    header.appendChild(title);
    header.appendChild(chevron);

    const drinksContainer = document.createElement("div");
    drinksContainer.className = "menu-drinks-container";

    items.forEach((drink) => {
      const card = document.createElement("div");
      card.className = "drink-card";

      const infoDiv = document.createElement("div");
      infoDiv.className = "drink-info";

      const nameDiv = document.createElement("div");
      nameDiv.className = "drink-name";
      nameDiv.textContent = drink.name;

      const descriptionDiv = document.createElement("div");
      descriptionDiv.className = "drink-description";
      descriptionDiv.textContent = drink.description || "";

      infoDiv.appendChild(nameDiv);
      if (drink.description) infoDiv.appendChild(descriptionDiv);

      const actionsDiv = document.createElement("div");
      actionsDiv.className = "drink-actions";

      const button = document.createElement("button");
      button.type = "button";
      button.className = "btn-select";
      button.textContent = "Select";
      button.onclick = () => {
        drinkSelectEl.value = drink.id;
      };

      actionsDiv.appendChild(button);

      card.appendChild(infoDiv);
      card.appendChild(actionsDiv);

      drinksContainer.appendChild(card);
    });

    header.addEventListener("click", () => {
      const isCollapsed = categoryDiv.classList.toggle("collapsed");
      chevron.textContent = isCollapsed ? "▸" : "▾";
    });

    categoryDiv.appendChild(header);
    categoryDiv.appendChild(drinksContainer);
    menuContainerEl.appendChild(categoryDiv);
  }
}


      function renderDrinkSelect() {
        drinkSelectEl.innerHTML = "";

        if (!currentMenuDrinks || currentMenuDrinks.length === 0) {
          const opt = document.createElement("option");
          opt.value = "";
          opt.textContent = "No drinks available";
          drinkSelectEl.appendChild(opt);
          drinkSelectEl.disabled = true;
          return;
        }

        drinkSelectEl.disabled = false;

        const defaultOpt = document.createElement("option");
        defaultOpt.value = "";
        defaultOpt.textContent = "Select a drink";
        drinkSelectEl.appendChild(defaultOpt);

        const drinksSorted = [...currentMenuDrinks].sort((a, b) =>
          a.name.localeCompare(b.name)
        );

        for (const drink of drinksSorted) {
          const opt = document.createElement("option");
          opt.value = drink.id;
          opt.textContent = drink.name;
          drinkSelectEl.appendChild(opt);
        }
      }

      function renderSyrupFlavourSelect() {
        syrupFlavourSelect.innerHTML = "";

        const syrupChoice = Array.from(syrupChoiceRadios).find(
          (r) => r.checked
        )?.value;

        if (syrupChoice !== "yes") {
          const opt = document.createElement("option");
          opt.value = "";
          opt.textContent = "No syrup selected";
          syrupFlavourSelect.appendChild(opt);
          syrupFlavourSelect.disabled = true;
          return;
        }

        if (!currentMenuSyrups || currentMenuSyrups.length === 0) {
          const opt = document.createElement("option");
          opt.value = "";
          opt.textContent = "No syrups available";
          syrupFlavourSelect.appendChild(opt);
          syrupFlavourSelect.disabled = true;
          return;
        }

        syrupFlavourSelect.disabled = false;

        const defaultOpt = document.createElement("option");
        defaultOpt.value = "";
        defaultOpt.textContent = "Select a flavour";
        syrupFlavourSelect.appendChild(defaultOpt);

        currentMenuSyrups.forEach((s) => {
          const opt = document.createElement("option");
          opt.value = s.name;
          opt.textContent = s.name;
          syrupFlavourSelect.appendChild(opt);
        });
      }

      function handleSyrupChoiceChange() {
        renderSyrupFlavourSelect();
      }

      syrupChoiceRadios.forEach((radio) => {
        radio.addEventListener("change", handleSyrupChoiceChange);
      });

      async function handleMenuChange() {
        const menuId = menuSelectEl.value;
        if (!menuId) {
          currentMenu = null;
          currentMenuDrinks = [];
          currentMenuSyrups = [];
          menuTitleEl.textContent = "Menu";
          menuDescriptionEl.textContent = "";
          menuLastUpdatedEl.textContent = "";
          renderMenu();
          renderDrinkSelect();
          renderSyrupFlavourSelect();
          return;
        }

        const selectedOption = menuSelectEl.selectedOptions[0];
        currentMenu = {
          id: menuId,
          name: selectedOption.dataset.menuName,
          description: selectedOption.dataset.menuDescription,
          last_updated: selectedOption.dataset.menuLastUpdated
        };

        menuTitleEl.textContent = currentMenu.name || "Menu";
        menuDescriptionEl.textContent =
          currentMenu.description || "Browse the drinks below.";

        if (currentMenu.last_updated) {
          const lastUpdatedDate = new Date(currentMenu.last_updated);
          if (!isNaN(lastUpdatedDate.getTime())) {
            menuLastUpdatedEl.textContent = `Last updated: ${lastUpdatedDate.toLocaleString()}`;
          } else {
            menuLastUpdatedEl.textContent = "";
          }
        } else {
          menuLastUpdatedEl.textContent = "";
        }

        currentMenuDrinks = await fetchMenuItems(menuId);
        currentMenuSyrups = await fetchMenuSyrups(menuId);

        renderMenu();
        renderDrinkSelect();
        renderSyrupFlavourSelect();
      }

      menuSelectEl.addEventListener("change", handleMenuChange);

      async function handleOrderSubmit(e) {
        e.preventDefault();
        setStatus("");
        submitOrderBtn.disabled = true;

        try {
          if (!currentMenu) {
            setStatus("No menu is selected.", true);
            return;
          }

          const customerName = customerNameInput.value.trim();
          const drinkId = drinkSelectEl.value;
          const selectedMilk = milkSelect.value || null;
          const syrupChoice = Array.from(syrupChoiceRadios).find(
            (r) => r.checked
          )?.value;
          const icedChoice = Array.from(icedChoiceRadios).find(
            (r) => r.checked
          )?.value;
          const syrupFlavour =
            syrupChoice === "yes" ? syrupFlavourSelect.value || null : null;
          const notes = notesInput.value.trim() || null;

          if (!customerName) {
            setStatus("Please enter your name.", true);
            return;
          }

          if (!drinkId) {
            setStatus("Please select a drink.", true);
            return;
          }

          const drinkItem = currentMenuDrinks.find(
            (drink) => drink.id === drinkId
          );
          if (!drinkItem) {
            setStatus("Selected drink not found. Please refresh.", true);
            return;
          }

          if (syrupChoice === "yes" && !syrupFlavour) {
            setStatus("Please select a syrup flavour.", true);
            return;
          }

          const payload = {
            customer_name: customerName,
            drink: drinkItem.name,
            milk: selectedMilk,
            syrup: syrupChoice === "yes",
            syrup_flavour:
              syrupChoice === "yes" && syrupFlavour ? syrupFlavour : null,
            iced: icedChoice === "yes",
            notes: notes || null
          };

          const { error } = await supabaseClient.from("orders").insert([
            {
              menu_id: currentMenu.id,
              ...payload
            }
          ]);

          if (error) {
            console.error("Error inserting order:", error);
            setStatus("Error submitting order. Please try again.", true);
            return;
          }

          orderForm.reset();
          // Reset defaults (hot, no syrup)
          document.querySelector('input[name="iced"][value="no"]').checked = true;
          document.querySelector('input[name="syrup"][value="no"]').checked = true;
          handleSyrupChoiceChange();

          setStatus("Order submitted successfully!", false, true);
        } catch (err) {
          console.error("Unexpected error submitting order:", err);
          setStatus(
            "Something broke. Not you. Probably the code.",
            true
          );
        } finally {
          submitOrderBtn.disabled = false;
        }
      }

      orderForm.addEventListener("submit", handleOrderSubmit);

      async function init() {
        setStatus("");
        menuContainerEl.innerHTML =
          "<p>Loading menu... assuming the espresso machine cooperates.</p>";

        const menus = await fetchMenus();

        menuSelectEl.innerHTML = "";
        const defaultOpt = document.createElement("option");
        defaultOpt.value = "";
        defaultOpt.textContent = "Select a menu";
        menuSelectEl.appendChild(defaultOpt);

        if (!menus || menus.length === 0) {
          menuContainerEl.innerHTML =
            '<p class="menu-empty-text">No menus available yet.</p>';
          drinkSelectEl.innerHTML = "";
          const opt = document.createElement("option");
          opt.value = "";
          opt.textContent = "No drinks available";
          drinkSelectEl.appendChild(opt);
          drinkSelectEl.disabled = true;
          syrupFlavourSelect.innerHTML = "";
          const syrupOpt = document.createElement("option");
          syrupOpt.value = "";
          syrupOpt.textContent = "No syrups available";
          syrupFlavourSelect.appendChild(syrupOpt);
          syrupFlavourSelect.disabled = true;
          return;
        }

        menus.forEach((menu) => {
          const opt = document.createElement("option");
          opt.value = menu.id;
          opt.textContent = menu.name || "Untitled menu";
          opt.dataset.menuName = menu.name || "Untitled menu";
          opt.dataset.menuDescription = menu.description || "";
          opt.dataset.menuLastUpdated = menu.updated_at || "";
          menuSelectEl.appendChild(opt);
        });

        const defaultMenu =
          menus.find((m) => m.is_default) || menus[0] || null;

        if (defaultMenu) {
          menuSelectEl.value = defaultMenu.id;
          await handleMenuChange();
        } else {
          currentMenu = null;
          currentMenuDrinks = [];
          currentMenuSyrups = [];
          renderMenu();
          renderDrinkSelect();
          renderSyrupFlavourSelect();
        }

        handleSyrupChoiceChange();
      }

      init();
    </script>
  </body>
</html>
